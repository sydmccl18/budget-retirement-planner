<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Goal-Based Budget + Retirement Planner (US)</title>
  <style>
    :root{
      --bg1:#eaf5ff;
      --bg2:#f6fbff;
      --card:#ffffff;
      --border:#e7eaf0;
      --text:#0f172a;
      --muted:#64748b;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --green:#10b981;
      --red:#ef4444;
      --shadow: 0 14px 40px rgba(15, 23, 42, .08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, var(--bg1), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, #e8fff7, transparent 60%),
        linear-gradient(180deg, var(--bg2), #f8fafc 55%, #ffffff);
    }
    .wrap{max-width:1100px;margin:32px auto;padding:0 18px}
    h1{margin:0 0 6px;font-size:46px;letter-spacing:-.02em}
    .sub{margin:0 0 22px;color:var(--muted);line-height:1.45}
    .grid{display:grid;grid-template-columns: 1.05fr .95fr; gap:16px; align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} h1{font-size:36px} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 12px;font-size:22px}
    .sectionTitle{
      margin:16px 0 10px;
      font-size:13px;
      letter-spacing:.12em;
      color:var(--muted);
      text-transform:uppercase;
      font-weight:700;
    }
    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select{
      width:100%;
      padding:12px 12px;
      border:1px solid #dbe1ea;
      border-radius:12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{border-color:#94a3b8; box-shadow:0 0 0 4px rgba(37,99,235,.08)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width: 620px){ .two{grid-template-columns:1fr} }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
    }
    .btnPrimary{background:var(--blue);color:#fff}
    .btnPrimary:hover{background:var(--blue2)}
    .btnDark{background:#0f172a;color:#fff}
    .btnGhost{background:#fff;border:1px solid #dbe1ea;color:#0f172a}
    .tip{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}

    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid #eff2f6;
      align-items:center;
    }
    .row:last-child{border-bottom:0}
    .kpi{font-weight:800; font-variant-numeric: tabular-nums; font-size:18px}
    .smallKpi{font-weight:800; font-variant-numeric: tabular-nums}
    .muted{color:var(--muted)}
    .hr{height:1px;background:#eff2f6;margin:14px 0}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      margin-top:10px;
    }
    .ok{background:#ecfdf3;border-color:#bfe8cc}
    .warn{background:#fff7ed;border-color:#fed7aa}
    .bad{background:#fff1f2;border-color:#fecdd3}
    .pill b{font-weight:800}

    .bars{margin-top:10px}
    .barLabel{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin:8px 0 6px}
    .barWrap{background:#eef2f7;border-radius:999px;height:14px;overflow:hidden}
    .bar{height:14px;width:0%}

    .toggle{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px; border:1px solid var(--border);
      border-radius:14px; background:#fbfdff;
      margin-top:10px;
    }
    .toggle label{margin:0;color:var(--text);font-size:13px;display:flex;gap:8px;align-items:center}
    .toggle input{width:auto}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th, td{border-bottom:1px solid #eff2f6;text-align:left;padding:10px 8px;font-size:13px;vertical-align:top}
    th{font-size:12px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}
    .noteBox{
      margin-top:12px;
      padding:12px 12px;
      border:1px dashed #cbd5e1;
      border-radius:14px;
      color:#334155;
      background:#f8fafc;
      font-size:12px;
      line-height:1.45;
    }
    .rangeWrap{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fbfdff;
    }
    .rangeRow{display:flex;justify-content:space-between;gap:12px;align-items:center}
    input[type="range"]{padding:0;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Goal-Based Budget + Retirement Planner (US)</h1>
    <p class="sub">
      Educational tool only; not financial advice. Simplified assumptions (constant returns, constant monthly contributions, ignores eligibility limits/taxes/plan specifics).
    </p>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <h2>Inputs</h2>

        <div class="sectionTitle">Monthly cash flow</div>
        <div class="two">
          <div>
            <label>Monthly Income</label>
            <input id="inpIncome" inputmode="decimal" placeholder="e.g., 6000" />
          </div>
          <div>
            <label>Monthly Expenses (total)</label>
            <input id="inpExpenses" inputmode="decimal" placeholder="e.g., 4200" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="two">
          <div>
            <label>Buffer % (safety margin)</label>
            <input id="inpBuffer" inputmode="decimal" placeholder="e.g., 10" />
          </div>
          <div>
            <label>Expected Return % (annual)</label>
            <input id="inpReturn" inputmode="decimal" placeholder="e.g., 7" />
          </div>
        </div>

        <div class="sectionTitle">Retirement goal</div>
        <div class="two">
          <div>
            <label>Current savings</label>
            <input id="inpCurrent" inputmode="decimal" placeholder="e.g., 15000" />
          </div>
          <div>
            <label>Target amount</label>
            <input id="inpTarget" inputmode="decimal" placeholder="e.g., 500000" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="two">
          <div>
            <label>Years to goal</label>
            <input id="inpYears" inputmode="decimal" placeholder="e.g., 25" />
          </div>
          <div>
            <label>Has employer retirement plan?</label>
            <select id="inpEmployer">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="two">
          <div>
            <label>Has HSA?</label>
            <select id="inpHsa">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div>
            <label>Employer match (% of income, optional)</label>
            <input id="inpMatchPct" inputmode="decimal" placeholder="e.g., 2" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="two">
          <div>
            <label>Tax preference (simplified)</label>
            <select id="inpTaxPref">
              <option value="roth">Prefer lower taxes later (Roth-leaning)</option>
              <option value="traditional">Prefer lower taxes now (Traditional-leaning)</option>
              <option value="neutral">Neutral / not sure</option>
            </select>
          </div>
          <div></div>
        </div>

        <div class="toggle" aria-label="recommended mode">
          <label><input type="radio" name="recMode" value="min" checked> Minimum to hit goal (if feasible)</label>
          <label><input type="radio" name="recMode" value="max"> Maximize within budget</label>
        </div>

        <div class="btnRow">
          <button class="btnPrimary" id="btnRecalc" type="button">Recalculate</button>
          <button class="btnDark" id="btnCopy" type="button">Copy Summary</button>
          <button class="btnGhost" id="btnReset" type="button">Reset</button>
        </div>

        <div class="tip">
          Tip: you can type <b>5000</b> or <b>5,000</b> or <b>$5,000</b> — it cleans it.
        </div>
        <div class="tip" id="copyMsg"></div>
      </div>

      <!-- OUTPUTS -->
      <div class="card">
        <h2>Outputs</h2>

        <div class="sectionTitle">Overview</div>
        <div class="row"><div>Income</div><div class="kpi" id="vIncome">$0.00</div></div>
        <div class="row"><div>Expenses</div><div class="kpi" id="vExpenses">$0.00</div></div>
        <div class="row"><div>Surplus</div><div class="kpi" id="vSurplus">$0.00</div></div>
        <div class="row"><div>Buffer %</div><div class="kpi" id="vBuffer">0%</div></div>
        <div class="row"><div>Safe surplus</div><div class="kpi" id="vSafe">$0.00</div></div>

        <div class="hr"></div>

        <div class="sectionTitle">Key ratios</div>
        <div class="row"><div>Savings rate (surplus ÷ income)</div><div class="kpi" id="vSaveRate">0%</div></div>
        <div class="row"><div>Expense ratio (expenses ÷ income)</div><div class="kpi" id="vExpRate">0%</div></div>
        <div class="row"><div>Buffer-adjusted savings (safe surplus ÷ income)</div><div class="kpi" id="vSafeRate">0%</div></div>

        <div class="hr"></div>

        <div class="sectionTitle">Retirement goal</div>
        <div class="row"><div>Current savings</div><div class="kpi" id="vCurrent">$0.00</div></div>
        <div class="row"><div>Target amount</div><div class="kpi" id="vTarget">$0.00</div></div>
        <div class="row"><div>Years to goal</div><div class="kpi" id="vYears">0</div></div>
        <div class="row"><div>Expected return %</div><div class="kpi" id="vReturn">0%</div></div>

        <div class="hr"></div>

        <div class="sectionTitle">Monthly investing</div>
        <div class="row"><div>Required monthly</div><div class="kpi" id="vReq">$0.00</div></div>
        <div class="row"><div>Feasible monthly (safe surplus)</div><div class="kpi" id="vFeas">$0.00</div></div>
        <div class="row"><div>Recommended monthly</div><div class="kpi" id="vRec">$0.00</div></div>
        <div class="row"><div>Status</div><div class="kpi" id="vStatus">—</div></div>
        <div class="row"><div>Gap (required − feasible)</div><div class="kpi" id="vGap">$0.00</div></div>

        <div class="bars">
          <div class="barLabel"><span>Required</span><span class="smallKpi" id="vReqSmall">$0.00</span></div>
          <div class="barWrap"><div class="bar" id="barReq" style="background:var(--red)"></div></div>

          <div class="barLabel"><span>Feasible</span><span class="smallKpi" id="vFeasSmall">$0.00</span></div>
          <div class="barWrap"><div class="bar" id="barFeas" style="background:var(--green)"></div></div>
        </div>

        <div id="statusBox"></div>

        <div class="hr"></div>

        <div class="sectionTitle">What if I invest a different amount?</div>
        <div class="rangeWrap">
          <div class="rangeRow">
            <div class="muted" style="font-size:12px">Actual monthly contribution</div>
            <div class="kpi">$<span id="vActualMonthly">0.00</span></div>
          </div>
          <input id="rngMonthly" type="range" min="0" max="1000" step="10" value="0" />
          <div class="rangeRow" style="margin-top:6px">
            <div class="muted" style="font-size:12px">$0</div>
            <div class="muted" style="font-size:12px">Max: $<span id="vRngMax">0</span></div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="row"><div>Projected value at goal</div><div class="kpi" id="vProjFV">$0.00</div></div>
        <div class="row"><div>Difference vs target</div><div class="kpi" id="vProjDiff">$0.00</div></div>
        <div id="investNote"></div>

        <div class="hr"></div>

        <div class="sectionTitle">Recommended accounts + monthly split</div>
        <div id="nextAction"></div>

        <table>
          <thead>
            <tr>
              <th style="width:44%">Account</th>
              <th style="width:16%">Monthly $</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody id="splitBody"></tbody>
        </table>

        <div class="noteBox">
          <b>Note:</b> This “split” is rules-based and simplified. It ignores IRS contribution limits, plan eligibility rules, match formulas/vesting, taxes, and exact plan fund options. It’s meant to demonstrate logic, not deliver personal investment advice.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- helpers ----------
    function cleanNumber(raw){
      const s = String(raw ?? "").trim();
      if(!s) return 0;
      const cleaned = s.replace(/[$,]/g,"");
      const v = Number(cleaned);
      return Number.isFinite(v) ? v : 0;
    }
    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function pct(n){
      const x = Number(n || 0);
      return x.toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:2}) + "%";
    }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // Required monthly to reach target FV given current PV, rate, time
    function requiredMonthlyContribution(current, target, years, retPct){
      const n = Math.round(Number(years||0) * 12);
      if(n <= 0) return 0;
      const r = (Number(retPct||0)/100)/12;
      const c = Number(current||0);
      const t = Number(target||0);

      if(Math.abs(r) < 1e-12){
        return Math.max(0, (t - c) / n);
      }
      const growth = Math.pow(1+r, n);
      const fvCurrent = c * growth;
      const denom = (growth - 1);
      if(Math.abs(denom) < 1e-12) return 0;
      return Math.max(0, (t - fvCurrent) * r / denom);
    }

    function futureValue(current, monthly, years, retPct){
      const n = Math.round(Number(years||0) * 12);
      if(n <= 0) return Number(current||0);
      const r = (Number(retPct||0)/100)/12;
      const c = Number(current||0);
      const p = Number(monthly||0);

      if(Math.abs(r) < 1e-12) return c + p*n;

      const growth = Math.pow(1+r, n);
      return c*growth + p*((growth - 1)/r);
    }

    // ---------- funding split ----------
    // Simplified monthly "caps" just to keep the split realistic-ish.
    // You can change these numbers if your professor wants different assumptions.
    const SIMPLIFIED_HSA_CAP_MONTHLY = 350;   // placeholder
    const SIMPLIFIED_IRA_CAP_MONTHLY = 600;   // placeholder

    function buildFundingSplit(params){
      const {
        monthlyToInvest,
        income,
        hasEmployerPlan,
        matchPct,
        hasHsa,
        taxPref
      } = params;

      let remaining = Math.max(0, Number(monthlyToInvest||0));
      const rows = [];

      // 1) 401k up to match (FIXED math): income * (matchPct/100) per month
      const matchMonthlyCap = (hasEmployerPlan && matchPct > 0)
        ? Math.max(0, income * (matchPct/100))
        : 0;

      const toMatch = Math.min(remaining, matchMonthlyCap);
      if(toMatch > 0.01){
        rows.push({
          account: "401(k) / 403(b) up to match",
          amt: toMatch,
          reason: "Captures employer match first (simplified cap = income × match%)."
        });
        remaining -= toMatch;
      }

      // 2) HSA (if eligible)
      if(hasHsa && remaining > 0.01){
        const hsaAmt = Math.min(remaining, SIMPLIFIED_HSA_CAP_MONTHLY);
        if(hsaAmt > 0.01){
          rows.push({
            account: "HSA",
            amt: hsaAmt,
            reason: "Tax-advantaged health + long-term investing (if eligible)."
          });
          remaining -= hsaAmt;
        }
      }

      // 3) IRA (Roth vs Traditional based on preference)
      if(remaining > 0.01){
        const iraName =
          (taxPref === "traditional") ? "Traditional IRA" :
          (taxPref === "roth") ? "Roth IRA" :
          "Roth IRA / Traditional IRA";

        const iraAmt = Math.min(remaining, SIMPLIFIED_IRA_CAP_MONTHLY);
        if(iraAmt > 0.01){
          rows.push({
            account: iraName,
            amt: iraAmt,
            reason: (taxPref === "traditional")
              ? "Prefers tax deduction now; taxes later (simplified rule)."
              : (taxPref === "roth")
                ? "Prefers tax-free growth later; taxes now (simplified rule)."
                : "Tax-advantaged retirement bucket (choice depends on situation)."
          });
          remaining -= iraAmt;
        }
      }

      // 4) Additional employer plan contributions (if plan exists)
      if(hasEmployerPlan && remaining > 0.01){
        rows.push({
          account: "401(k) / 403(b) additional",
          amt: remaining,
          reason: "Increase workplace retirement savings after match/HSA/IRA."
        });
        remaining = 0;
      }

      // 5) Otherwise taxable brokerage
      if(remaining > 0.01){
        rows.push({
          account: "Taxable brokerage",
          amt: remaining,
          reason: "Flexible investing after tax-advantaged buckets."
        });
        remaining = 0;
      }

      // If nothing allocated, still show something
      if(rows.length === 0){
        rows.push({
          account: "—",
          amt: 0,
          reason: "Enter inputs and choose a monthly contribution to see a suggested split."
        });
      }

      return rows;
    }

    function renderSplit(rows){
      const body = document.getElementById("splitBody");
      body.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.account}</td>
          <td><b>$${money(r.amt)}</b></td>
          <td class="muted" style="line-height:1.35">${r.reason}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderNextAction(rows){
      const box = document.getElementById("nextAction");
      box.innerHTML = "";

      // Find first meaningful row
      const first = rows.find(r => (r.amt || 0) > 0.01);
      if(!first){
        box.innerHTML = `<div class="pill warn"><b>Next:</b> Choose a monthly contribution to generate a plan.</div>`;
        return;
      }
      box.innerHTML = `<div class="pill ok"><b>Next best action:</b> Contribute <b>$${money(first.amt)}/mo</b> to <b>${first.account}</b>.</div>`;
    }

    // ---------- main calc + render ----------
    function getRecMode(){
      const r = document.querySelector('input[name="recMode"]:checked');
      return r ? r.value : "min";
    }

    function recalcAll(){
      const income = cleanNumber(document.getElementById("inpIncome").value);
      const expenses = cleanNumber(document.getElementById("inpExpenses").value);
      const bufferPct = cleanNumber(document.getElementById("inpBuffer").value);
      const retPct = cleanNumber(document.getElementById("inpReturn").value);

      const current = cleanNumber(document.getElementById("inpCurrent").value);
      const target = cleanNumber(document.getElementById("inpTarget").value);
      const years = cleanNumber(document.getElementById("inpYears").value);

      const hasEmployerPlan = document.getElementById("inpEmployer").value === "yes";
      const hasHsa = document.getElementById("inpHsa").value === "yes";
      const matchPct = cleanNumber(document.getElementById("inpMatchPct").value);
      const taxPref = document.getElementById("inpTaxPref").value;

      const surplus = income - expenses;
      const safeSurplus = surplus * (1 - bufferPct/100);
      const feasible = Math.max(0, safeSurplus);

      const required = requiredMonthlyContribution(current, target, years, retPct);
      const gap = required - feasible;

      const mode = getRecMode();
      const recommended = (mode === "max")
        ? feasible
        : Math.max(0, Math.min(required, feasible));

      const status = (feasible + 1e-9 >= required) ? "Feasible" : "Not feasible";
      const statusBox = document.getElementById("statusBox");
      statusBox.innerHTML = "";
      if(required <= 0.01){
        statusBox.innerHTML = `<div class="pill warn"><b>Note:</b> Enter a positive target and timeline to compute required monthly.</div>`;
      } else if(status === "Feasible"){
        statusBox.innerHTML = `<div class="pill ok"><b>Feasible:</b> Your budget supports the goal under these simplified assumptions.</div>`;
      } else {
        statusBox.innerHTML = `<div class="pill bad"><b>Shortfall:</b> You’re short by about <b>$${money(gap)}/mo</b> (required − feasible).</div>`;
      }

      // Ratios (handle income=0)
      const saveRate = (income > 0) ? (surplus / income) : 0;
      const expRate  = (income > 0) ? (expenses / income) : 0;
      const safeRate = (income > 0) ? (safeSurplus / income) : 0;

      // Write top KPIs
      document.getElementById("vIncome").textContent = "$" + money(income);
      document.getElementById("vExpenses").textContent = "$" + money(expenses);
      document.getElementById("vSurplus").textContent = "$" + money(surplus);
      document.getElementById("vBuffer").textContent = pct(bufferPct);
      document.getElementById("vSafe").textContent = "$" + money(safeSurplus);

      document.getElementById("vSaveRate").textContent = pct(saveRate * 100);
      document.getElementById("vExpRate").textContent  = pct(expRate * 100);
      document.getElementById("vSafeRate").textContent = pct(safeRate * 100);

      document.getElementById("vCurrent").textContent = "$" + money(current);
      document.getElementById("vTarget").textContent = "$" + money(target);
      document.getElementById("vYears").textContent = String(years || 0);
      document.getElementById("vReturn").textContent = pct(retPct);

      document.getElementById("vReq").textContent = "$" + money(required);
      document.getElementById("vFeas").textContent = "$" + money(feasible);
      document.getElementById("vRec").textContent = "$" + money(recommended);
      document.getElementById("vStatus").textContent = status;
      document.getElementById("vGap").textContent = "$" + money(required - feasible);

      document.getElementById("vReqSmall").textContent = "$" + money(required);
      document.getElementById("vFeasSmall").textContent = "$" + money(feasible);

      // Bars
      const maxv = Math.max(required, feasible, 1);
      document.getElementById("barReq").style.width  = ((required/maxv)*100).toFixed(1) + "%";
      document.getElementById("barFeas").style.width = ((feasible/maxv)*100).toFixed(1) + "%";

      // Slider setup (max scales with feasible; if feasible is 0, still give a usable range)
      const rng = document.getElementById("rngMonthly");
      const maxSlider = Math.max(500, Math.ceil((feasible * 2) / 10) * 10); // 2x feasible, rounded to $10
      rng.max = String(maxSlider);
      document.getElementById("vRngMax").textContent = money(maxSlider);

      // Default slider value = recommended (clamped)
      const defaultActual = clamp(Math.round(recommended/10)*10, 0, maxSlider);
      rng.value = String(defaultActual);
      document.getElementById("vActualMonthly").textContent = money(defaultActual);

      // Projected FV & diff for the slider amount
      const fv = futureValue(current, defaultActual, years, retPct);
      const diff = fv - target;
      document.getElementById("vProjFV").textContent = "$" + money(fv);
      document.getElementById("vProjDiff").textContent = (diff >= 0 ? "+" : "") + "$" + money(diff);

      const investNote = document.getElementById("investNote");
      investNote.innerHTML = "";
      if(target > 0.01 && years > 0.01){
        if(diff >= 0){
          investNote.innerHTML = `<div class="pill ok"><b>On track:</b> This contribution would reach (or exceed) the target under simplified assumptions.</div>`;
        } else {
          investNote.innerHTML = `<div class="pill warn"><b>Below target:</b> This contribution would fall short by <b>$${money(Math.abs(diff))}</b> at the goal date.</div>`;
        }
      }

      // Funding split based on ACTUAL monthly (slider value)
      const split = buildFundingSplit({
        monthlyToInvest: defaultActual,
        income,
        hasEmployerPlan,
        matchPct,
        hasHsa,
        taxPref
      });
      renderSplit(split);
      renderNextAction(split);
    }

    function onSliderChange(){
      const income = cleanNumber(document.getElementById("inpIncome").value);
      const current = cleanNumber(document.getElementById("inpCurrent").value);
      const target = cleanNumber(document.getElementById("inpTarget").value);
      const years = cleanNumber(document.getElementById("inpYears").value);
      const retPct = cleanNumber(document.getElementById("inpReturn").value);

      const hasEmployerPlan = document.getElementById("inpEmployer").value === "yes";
      const hasHsa = document.getElementById("inpHsa").value === "yes";
      const matchPct = cleanNumber(document.getElementById("inpMatchPct").value);
      const taxPref = document.getElementById("inpTaxPref").value;

      const rng = document.getElementById("rngMonthly");
      const actual = cleanNumber(rng.value);

      document.getElementById("vActualMonthly").textContent = money(actual);

      const fv = futureValue(current, actual, years, retPct);
      const diff = fv - target;
      document.getElementById("vProjFV").textContent = "$" + money(fv);
      document.getElementById("vProjDiff").textContent = (diff >= 0 ? "+" : "") + "$" + money(diff);

      const investNote = document.getElementById("investNote");
      investNote.innerHTML = "";
      if(target > 0.01 && years > 0.01){
        if(diff >= 0){
          investNote.innerHTML = `<div class="pill ok"><b>On track:</b> This contribution would reach (or exceed) the target under simplified assumptions.</div>`;
        } else {
          investNote.innerHTML = `<div class="pill warn"><b>Below target:</b> This contribution would fall short by <b>$${money(Math.abs(diff))}</b> at the goal date.</div>`;
        }
      }

      const split = buildFundingSplit({
        monthlyToInvest: actual,
        income,
        hasEmployerPlan,
        matchPct,
        hasHsa,
        taxPref
      });
      renderSplit(split);
      renderNextAction(split);
    }

    function copySummary(){
      const income = cleanNumber(document.getElementById("inpIncome").value);
      const expenses = cleanNumber(document.getElementById("inpExpenses").value);
      const bufferPct = cleanNumber(document.getElementById("inpBuffer").value);
      const retPct = cleanNumber(document.getElementById("inpReturn").value);
      const current = cleanNumber(document.getElementById("inpCurrent").value);
      const target = cleanNumber(document.getElementById("inpTarget").value);
      const years = cleanNumber(document.getElementById("inpYears").value);

      const surplus = income - expenses;
      const safeSurplus = surplus * (1 - bufferPct/100);
      const feasible = Math.max(0, safeSurplus);
      const required = requiredMonthlyContribution(current, target, years, retPct);

      const rng = document.getElementById("rngMonthly");
      const actual = cleanNumber(rng.value);

      const lines = [];
      lines.push("Goal-Based Budget + Retirement Planner (US) — Summary");
      lines.push(`Income: $${money(income)} | Expenses: $${money(expenses)} | Surplus: $${money(surplus)} | Buffer: ${pct(bufferPct)}`);
      lines.push(`Safe surplus (feasible): $${money(feasible)}/mo`);
      lines.push(`Goal: $${money(target)} in ${years} years (current: $${money(current)}, return: ${pct(retPct)})`);
      lines.push(`Required monthly: $${money(required)} | Selected monthly (slider): $${money(actual)}`);

      const splitRows = Array.from(document.querySelectorAll("#splitBody tr")).map(tr=>{
        const tds = tr.querySelectorAll("td");
        if(tds.length < 2) return null;
        const account = tds[0].innerText.trim();
        const amt = tds[1].innerText.trim();
        return `- ${account}: ${amt}`;
      }).filter(Boolean);

      if(splitRows.length){
        lines.push("Funding split:");
        lines.push(...splitRows);
      }

      const text = lines.join("\n");
      navigator.clipboard.writeText(text).then(()=>{
        const msg = document.getElementById("copyMsg");
        msg.textContent = "Copied to clipboard.";
        setTimeout(()=> msg.textContent = "", 1500);
      }).catch(()=>{
        const msg = document.getElementById("copyMsg");
        msg.textContent = "Copy failed (browser permissions).";
        setTimeout(()=> msg.textContent = "", 2000);
      });
    }

    function resetAll(){
      ["inpIncome","inpExpenses","inpBuffer","inpReturn","inpCurrent","inpTarget","inpYears","inpMatchPct"].forEach(id=>{
        document.getElementById(id).value = "";
      });
      document.getElementById("inpEmployer").value = "no";
      document.getElementById("inpHsa").value = "no";
      document.getElementById("inpTaxPref").value = "roth";
      document.querySelector('input[name="recMode"][value="min"]').checked = true;
      recalcAll();
    }

    // ---------- wire up ----------
    document.getElementById("btnRecalc").addEventListener("click", recalcAll);
    document.getElementById("btnCopy").addEventListener("click", copySummary);
    document.getElementById("btnReset").addEventListener("click", resetAll);

    document.getElementById("rngMonthly").addEventListener("input", onSliderChange);

    document.querySelectorAll('input[name="recMode"]').forEach(r=>{
      r.addEventListener("change", recalcAll);
    });

    // Recalc when key dropdowns change (keeps split accurate)
    ["inpEmployer","inpHsa","inpTaxPref"].forEach(id=>{
      document.getElementById(id).addEventListener("change", recalcAll);
    });

    // initial render
    recalcAll();
  </script>
</body>
</html>

